{% extends "base.html" %}

{% block title %}Admin - Matrix-Game Evaluation{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">Evaluation Progress Dashboard</h1>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <h5 class="card-title">Total Comparisons</h5>
                <p class="card-text display-4" id="total-comparisons">-</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success">
            <div class="card-body">
                <h5 class="card-title">Total Evaluations</h5>
                <p class="card-text display-4" id="total-evaluations">-</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-info">
            <div class="card-body">
                <h5 class="card-title">Target per Comparison</h5>
                <p class="card-text display-4" id="target-evaluations">-</p>
            </div>
        </div>
    </div>
</div>

<!-- Evaluations by Scenario -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Evaluations by Scenario</h5>
            </div>
            <div class="card-body">
                <div id="scenario-chart" style="height: 400px;">
                    <div class="text-center p-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comparison Details Table -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Comparison Details</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="comparisons-table">
                        <thead>
                            <tr>
                                <th>Comparison ID</th>
                                <th>Scenario</th>
                                <th>Created</th>
                                <th>Evaluations</th>
                                <th>Progress</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function() {
    let scenarioChart = null;
    
    // Load statistics
    function loadStats() {
        $.get('/api/evaluation_stats', function(data) {
            $('#total-comparisons').text(data.total_comparisons);
            $('#total-evaluations').text(data.total_evaluations);
            $('#target-evaluations').text(data.target_evaluations_per_comparison);
            
            // Update scenario chart
            updateScenarioChart(data.evaluations_by_scenario);
        });
    }
    
    // Load comparisons table
    function loadComparisons() {
        $.get('/api/comparisons', function(data) {
            const tbody = $('#comparisons-table tbody');
            tbody.empty();
            
            if (data.length === 0) {
                tbody.html('<tr><td colspan="6" class="text-center">No comparisons found</td></tr>');
                return;
            }
            
            // Get target evaluations
            $.get('/api/evaluation_stats', function(stats) {
                const target = stats.target_evaluations_per_comparison;
                
                data.forEach(function(comp) {
                    const progress = (comp.num_evaluations / target) * 100;
                    const progressClass = progress >= 100 ? 'bg-success' : 'bg-primary';
                    
                    const row = $('<tr>');
                    row.append(`<td><small>${comp.comparison_id.substring(0, 8)}...</small></td>`);
                    row.append(`<td>${comp.scenario_id}</td>`);
                    row.append(`<td>${new Date(comp.created_at).toLocaleDateString()}</td>`);
                    row.append(`<td>${comp.num_evaluations} / ${target}</td>`);
                    row.append(`
                        <td>
                            <div class="progress">
                                <div class="progress-bar ${progressClass}" 
                                     style="width: ${Math.min(progress, 100)}%">
                                    ${Math.round(progress)}%
                                </div>
                            </div>
                        </td>
                    `);
                    row.append(`
                        <td>
                            <a href="${comp.evaluation_url}" class="btn btn-sm btn-outline-primary">
                                Evaluate
                            </a>
                        </td>
                    `);
                    tbody.append(row);
                });
            });
        });
    }
    
    // Update scenario chart
    function updateScenarioChart(data) {
        const ctx = document.getElementById('scenario-chart');
        
        // Clear loading spinner
        ctx.innerHTML = '<canvas></canvas>';
        const canvas = ctx.querySelector('canvas');
        
        const labels = Object.keys(data);
        const values = Object.values(data);
        
        if (scenarioChart) {
            scenarioChart.destroy();
        }
        
        scenarioChart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Evaluations',
                    data: values,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    
    // Initial load
    loadStats();
    loadComparisons();
    
    // Refresh every 30 seconds
    setInterval(function() {
        loadStats();
        loadComparisons();
    }, 30000);
});
</script>
{% endblock %}